<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Church Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --tg-theme-bg-color: var(--tg-theme-bg-color, #ffffff);
            --tg-theme-text-color: var(--tg-theme-text-color, #000000);
            --tg-theme-hint-color: var(--tg-theme-hint-color, #999999);
            --tg-theme-link-color: var(--tg-theme-link-color, #2481cc);
            --tg-theme-button-color: var(--tg-theme-button-color, #2481cc);
            --tg-theme-button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --tg-theme-secondary-bg-color: var(--tg-theme-secondary-bg-color, #efeff4);
            --tg-theme-header-bg-color: var(--tg-theme-header-bg-color, #ffffff);
        }
        body {
            color: var(--tg-theme-text-color);
            background: var(--tg-theme-bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            transition: background-color 0.3s ease;
            margin: 0;
            padding: 16px;
        }
        .card {
            background: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .card:active {
            transform: scale(0.98);
        }
        .btn-primary {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border-radius: 12px;
            padding: 12px 20px;
            font-weight: 600;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-primary:active {
            opacity: 0.8;
        }
        .input-field {
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 12px;
            padding: 12px 16px;
            width: 100%;
            outline: none;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            border-color: var(--tg-theme-link-color);
        }
        .tab-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--tg-theme-hint-color);
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .tab-btn.active {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            box-shadow: 0 4px 12px rgba(36, 129, 204, 0.3);
        }
        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .detail-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--tg-theme-hint-color);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .detail-value {
            font-size: 1rem;
            color: var(--tg-theme-text-color);
        }
        #search-results {
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            border: 1px solid var(--tg-theme-secondary-bg-color);
        }
        /* Дополнительные стили для темной темы */
        .text-hint { color: var(--tg-theme-hint-color); }
        .bg-secondary { background: var(--tg-theme-secondary-bg-color); }
        .bg-main { background: var(--tg-theme-bg-color); }
        .border-theme { border-color: rgba(255,255,255,0.1); }
    </style>
</head>
<body class="p-4 pb-20">
    <div id="app">
        <header class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold">Church Database</h1>
            <div class="flex gap-2">
                <button onclick="showSearch()" class="p-2"><i class="fas fa-search"></i></button>
                <button onclick="viewMode('add')" class="p-2"><i class="fas fa-plus"></i></button>
            </div>
        </header>

        <div id="search-container" class="mb-4 hidden relative">
            <div class="relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="search-input" class="input-field pl-11" placeholder="Поиск по имени, фамилии или домашке..." oninput="handleSearch(this.value)">
                <button onclick="hideSearch()" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="search-results" class="mt-2 max-h-60 overflow-y-auto shadow-xl rounded-2xl hidden absolute z-50 w-full left-0 right-0 border border-theme bg-main p-2 space-y-1"></div>
        </div>

        <nav class="flex justify-between p-1 bg-secondary rounded-2xl mb-8 border border-theme">
            <button onclick="setTab('people')" id="tab-people" class="tab-btn active flex-1">Люди</button>
            <button onclick="setTab('homerooms')" id="tab-homerooms" class="tab-btn flex-1">Домашки</button>
            <button onclick="setTab('birthdays')" id="tab-birthdays" class="tab-btn flex-1">ДР</button>
            <button onclick="setTab('ai')" id="tab-ai" class="tab-btn flex-1 text-xs">AI</button>
        </nav>

        <div id="content-loading" class="text-center py-10 hidden">
            <i class="fas fa-spinner fa-spin text-3xl"></i>
        </div>

        <div id="view-people" class="view">
            <div id="people-list"></div>
        </div>

        <div id="view-homerooms" class="view hidden">
            <div id="homerooms-list"></div>
        </div>

        <div id="view-birthdays" class="view hidden">
            <div id="birthdays-list"></div>
        </div>

        <div id="view-ai" class="view hidden">
            <div class="card">
                <h3 class="font-bold mb-2">Задайте вопрос о базе данных</h3>
                <textarea id="ai-question" class="input-field mb-2" rows="3" placeholder="Например: Кто родился в мае?"></textarea>
                <button onclick="askAI()" class="btn-primary w-full py-4 shadow-lg shadow-blue-500/20">
                    <i class="fas fa-magic mr-2"></i> Спросить AI
                </button>
                <div id="ai-answer" class="mt-4 text-sm whitespace-pre-wrap"></div>
            </div>
        </div>

        <div id="view-details" class="view hidden">
            <h2 class="text-lg font-bold mb-4">Просмотр карточки</h2>
            <div id="details-content" class="space-y-3"></div>
            <div class="flex flex-col gap-2 mt-8">
                <button onclick="editCurrentPerson()" class="btn-primary w-full py-4 rounded-2xl shadow-lg shadow-blue-500/20">
                    <i class="fas fa-edit mr-2"></i> Редактировать
                </button>
                <button onclick="viewMode('main')" class="bg-secondary text-hint font-bold w-full py-4 rounded-2xl transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i> Назад к списку
                </button>
            </div>
        </div>

        <div id="view-edit" class="view hidden">
            <h2 id="edit-title" class="text-lg font-bold mb-4">Редактирование</h2>
            <div id="edit-form" class="space-y-4"></div>
            <div class="flex gap-2 mt-6">
                <button onclick="savePerson()" class="btn-primary flex-1 py-4 shadow-lg shadow-blue-500/20">
                    <i class="fas fa-check mr-2"></i> Сохранить
                </button>
                <button onclick="cancelEdit()" class="bg-secondary text-hint font-bold rounded-2xl px-4 py-4 flex-1 transition-colors">
                    Отмена
                </button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let currentTab = 'people';
        let allPeople = [];
        let headers = [];
        let config = {};
        let editingRow = null;
        let currentPerson = null;

        async function init() {
            showLoading(true);
            try {
                const [hRes, cRes] = await Promise.all([
                    fetch('/api/miniapp/headers'),
                    fetch('/api/miniapp/config')
                ]);
                headers = await hRes.json();
                config = await cRes.json();
                await loadPeople();
            } catch (e) {
                console.error(e);
            }
            showLoading(false);
        }

        async function loadPeople() {
            const res = await fetch('/api/miniapp/people');
            allPeople = await res.json();
            renderPeople();
        }

        function renderPeople() {
            const container = document.getElementById('people-list');
            container.innerHTML = allPeople.map(p => {
                const photoUrl = p[config.col_photo];
                const avatar = photoUrl
                    ? `<img src="${photoUrl}" class="w-14 h-14 rounded-2xl object-cover mr-4 shadow-md border border-theme">`
                    : `<div class="w-14 h-14 bg-gradient-to-br from-blue-400 to-blue-600 rounded-2xl flex items-center justify-center text-white text-lg font-bold mr-4 shadow-md border border-theme">
                        ${(p['Имя'] || '?').charAt(0)}${(p['Фамилия'] || '').charAt(0)}
                       </div>`;
                
                return `
                <div class="card flex items-center p-4 hover:border-blue-200 transition-all active:scale-[0.97]" onclick="viewPerson(${p.row_index})">
                    ${avatar}
                    <div class="flex-1 min-w-0">
                        <div class="font-black text-lg leading-tight truncate">${p['Имя'] || ''} ${p['Фамилия'] || ''}</div>
                        <div class="text-xs font-bold text-hint flex items-center gap-1 mt-1">
                            <i class="fas fa-home text-[10px] text-blue-400"></i> <span class="truncate">${p['Домашка'] || 'Не распределен'}</span>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <span class="px-2 py-0.5 rounded-lg bg-blue-500/10 text-blue-500 text-[10px] font-black uppercase tracking-wider">${p['Статус'] || 'Прихожанин'}</span>
                        </div>
                    </div>
                    <div class="ml-2 w-8 h-8 rounded-full bg-main/50 flex items-center justify-center text-hint">
                        <i class="fas fa-chevron-right text-[10px]"></i>
                    </div>
                </div>
                `;
            }).join('');
        }

        function showSearch() {
            const container = document.getElementById('search-container');
            container.classList.toggle('hidden');
            if (!container.classList.contains('hidden')) {
                document.getElementById('search-input').focus();
            }
        }

        function handleSearch(query) {
            const resultsContainer = document.getElementById('search-results');
            if (!query || query.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }

            const filtered = allPeople.filter(p => {
                const firstName = (p['Имя'] || '').toLowerCase();
                const lastName = (p['Фамилия'] || '').toLowerCase();
                const homeroom = (p['Домашка'] || '').toLowerCase();
                const q = query.toLowerCase();
                
                return firstName.includes(q) || lastName.includes(q) || homeroom.includes(q);
            }).slice(0, 10);

            if (filtered.length > 0) {
                resultsContainer.innerHTML = filtered.map(p => `
                    <div class="flex items-center p-3 hover:bg-blue-50 rounded-xl cursor-pointer transition-colors group" onclick="viewPerson(${p.row_index}); hideSearch();">
                        <div class="w-10 h-10 rounded-lg bg-blue-500/10 text-blue-500 flex items-center justify-center font-bold mr-3 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                            ${(p['Имя'] || '?').charAt(0)}
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-sm">${p['Имя'] || ''} ${p['Фамилия'] || ''}</div>
                            <div class="text-[10px] text-hint flex items-center gap-1">
                                <i class="fas fa-home text-[8px]"></i> ${p['Домашка'] || 'Нет домашки'}
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-[10px] text-hint"></i>
                    </div>
                `).join('');
                resultsContainer.classList.remove('hidden');
            } else {
                resultsContainer.innerHTML = '<div class="p-4 text-center text-sm text-hint">Ничего не найдено</div>';
                resultsContainer.classList.remove('hidden');
            }
        }

        function hideSearch() {
            document.getElementById('search-container').classList.add('hidden');
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('search-input').value = '';
        }

        async function loadHomerooms() {
            showLoading(true);
            const res = await fetch('/api/miniapp/homerooms');
            const data = await res.json();
            const container = document.getElementById('homerooms-list');
            container.innerHTML = Object.entries(data).map(([name, people]) => `
                <div class="card p-0 mb-4 overflow-hidden">
                    <div class="bg-blue-500/10 px-4 py-2 border-b border-theme flex justify-between items-center">
                        <h3 class="font-black text-blue-500 text-sm uppercase tracking-wider">${name}</h3>
                        <span class="bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)] text-[10px] px-2 py-0.5 rounded-full font-bold">${people.length}</span>
                    </div>
                    <div class="p-2 space-y-1">
                        ${people.map(p => `
                            <div class="flex items-center justify-between p-2 hover:bg-main/50 rounded-xl transition-colors cursor-pointer" onclick="viewPerson(${p.row_index})">
                                <div class="text-sm font-semibold">${p.name}</div>
                                <div class="flex gap-2 items-center">
                                    <span class="text-[10px] font-bold text-hint bg-main px-2 py-0.5 rounded-md">${p.age_str}</span>
                                    <i class="fas fa-chevron-right text-[10px] text-hint"></i>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            showLoading(false);
        }

        async function loadBirthdays() {
            showLoading(true);
            const res = await fetch('/api/miniapp/birthdays');
            const data = await res.json();
            const months = ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"];
            const container = document.getElementById('birthdays-list');
            const currentMonth = new Date().getMonth() + 1;

            container.innerHTML = months.map((m, i) => {
                const monthNum = i + 1;
                const people = data[monthNum] || [];
                if (people.length === 0) return '';
                
                const isCurrent = monthNum === currentMonth;
                
                return `
                    <div class="card p-0 ${isCurrent ? 'ring-2 ring-blue-500 bg-blue-500/10' : ''} border border-theme mb-6 overflow-hidden">
                        <div class="${isCurrent ? 'bg-blue-500 text-white' : 'bg-main text-hint'} px-4 py-3 border-b border-theme flex justify-between items-center">
                            <h3 class="font-black text-sm uppercase tracking-widest">${m}</h3>
                            ${isCurrent ? '<span class="text-[10px] font-black bg-main text-blue-500 px-2 py-0.5 rounded-full uppercase">Этот месяц</span>' : ''}
                        </div>
                        <div class="p-2">
                            ${people.map(p => `
                                <div class="flex items-center gap-4 p-3 hover:bg-main hover:shadow-sm rounded-2xl transition-all cursor-pointer" onclick="viewPerson(${p.row_index})">
                                    <div class="w-10 h-10 rounded-xl ${isCurrent ? 'bg-blue-100 text-blue-600' : 'bg-secondary text-hint'} flex flex-col items-center justify-center flex-shrink-0">
                                        <span class="text-xs font-black leading-none">${p.day}</span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-sm font-bold truncate">${p.name}</div>
                                        <div class="text-[10px] text-hint font-bold">${p.year} г.р.</div>
                                    </div>
                                    <i class="fas fa-gift ${isCurrent ? 'text-pink-400' : 'text-hint/20'}"></i>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            showLoading(false);
        }

        function setTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');

            if (tab === 'people') renderPeople();
            if (tab === 'homerooms') loadHomerooms();
            if (tab === 'birthdays') loadBirthdays();
        }

        function viewMode(mode) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            if (mode === 'main') {
                document.getElementById(`view-${currentTab}`).classList.remove('hidden');
            } else if (mode === 'add') {
                editingRow = null;
                showEditForm({});
            }
        }

        function viewPerson(rowIndex) {
            currentPerson = allPeople.find(p => p.row_index === rowIndex);
            if (!currentPerson) return;
            
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            const container = document.getElementById('view-details');
            container.classList.remove('hidden');
            
            const content = document.getElementById('details-content');
            const photoUrl = currentPerson[config.col_photo];
            
            // Generate initials
            const initials = `${(currentPerson['Имя'] || '?').charAt(0)}${(currentPerson['Фамилия'] || '').charAt(0)}`.toUpperCase();
            
            const avatar = photoUrl
                ? `<div class="relative inline-block">
                    <img src="${photoUrl}" class="w-32 h-32 rounded-3xl object-cover shadow-2xl border-2 border-theme">
                    <button onclick="triggerPhotoUpload()" class="absolute -bottom-2 -right-2 bg-blue-500 text-white w-10 h-10 rounded-full shadow-xl border-4 border-main flex items-center justify-center hover:bg-blue-600 transition-all active:scale-90">
                        <i class="fas fa-camera"></i>
                    </button>
                   </div>`
                : `<div class="relative inline-block">
                    <div class="w-32 h-32 bg-gradient-to-br from-blue-400 to-blue-600 rounded-3xl flex items-center justify-center text-white text-4xl font-bold shadow-xl border-2 border-theme">
                        ${initials}
                    </div>
                    <button onclick="triggerPhotoUpload()" class="absolute -bottom-2 -right-2 bg-blue-500 text-white w-10 h-10 rounded-full shadow-xl border-4 border-main flex items-center justify-center hover:bg-blue-600 transition-all active:scale-90">
                        <i class="fas fa-camera"></i>
                    </button>
                   </div>`;

            let fieldsHtml = headers.map(h => {
                let val = currentPerson[h];
                if (!val || val.toString().trim() === '' || h === 'Имя' || h === 'Фамилия' || h === config.col_photo) return '';
                
                // Format date for display if it's a date column
                if (config.date_columns.includes(h)) {
                    val = formatDateForDisplay(val);
                }

                let icon = 'fa-info-circle';
                if (h === 'Домашка') icon = 'fa-home';
                if (h === 'Статус') icon = 'fa-user-tag';
                if (h === 'Дата рождения') icon = 'fa-birthday-cake';
                if (h === 'Телефон') icon = 'fa-phone';
                if (h === 'Telegram') icon = 'fa-paper-plane';

                return `
                    <div class="flex items-start gap-4 p-3 bg-secondary rounded-2xl border border-theme">
                        <div class="w-8 h-8 rounded-full bg-main shadow-sm flex items-center justify-center text-blue-500 flex-shrink-0 mt-0.5">
                            <i class="fas ${icon} text-xs"></i>
                        </div>
                        <div>
                            <div class="text-[10px] font-bold text-hint uppercase tracking-wider mb-0.5">${h}</div>
                            <div class="text-sm font-semibold">${val}</div>
                        </div>
                    </div>
                `;
            }).join('');

            content.innerHTML = `
                <div class="flex flex-col items-center mb-8 py-4">
                    ${avatar}
                    <h2 class="text-2xl font-black mt-4 tracking-tight">${currentPerson['Имя'] || ''} ${currentPerson['Фамилия'] || ''}</h2>
                    <div class="text-blue-500 font-bold text-sm mt-1 px-3 py-1 bg-blue-500/10 rounded-full border border-blue-500/20">
                        ${currentPerson['Статус'] || 'Прихожанин'}
                    </div>
                    <input type="file" id="photo-upload" class="hidden" accept="image/*" onchange="uploadPhoto(this)">
                </div>
                
                <div class="grid grid-cols-1 gap-3">
                    ${fieldsHtml || '<div class="text-center text-hint py-4 italic text-sm">Нет дополнительных данных</div>'}
                </div>
            `;
        }

        function formatDateForDisplay(val) {
            if (!val) return '';
            // If already DD.MM.YYYY
            if (/^\d{2}\.\d{2}\.\d{4}$/.test(val)) return val;
            // If YYYY-MM-DD
            const parts = val.split('-');
            if (parts.length === 3) {
                return `${parts[2]}.${parts[1]}.${parts[0]}`;
            }
            return val;
        }

        function editCurrentPerson() {
            editingRow = currentPerson.row_index;
            showEditForm(currentPerson);
        }

        function cancelEdit() {
            if (editingRow) {
                viewPerson(editingRow);
            } else {
                viewMode('main');
            }
        }

        function showEditForm(person) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById('view-edit').classList.remove('hidden');
            document.getElementById('edit-title').innerText = editingRow ? 'Редактирование' : 'Новая карточка';
            
            const form = document.getElementById('edit-form');
            form.innerHTML = headers.map(h => {
                const val = person[h] || '';
                if (h === config.col_photo) return ''; // Don't edit photo URL directly

                let input = `<input type="text" id="field-${h}" class="input-field" placeholder="Введите ${h.toLowerCase()}..." value="${val}">`;
                
                if (config.date_columns.includes(h)) {
                    input = `<div class="relative">
                        <i class="fas fa-calendar absolute left-4 top-1/2 -translate-y-1/2 text-gray-300 text-sm"></i>
                        <input type="date" id="field-${h}" class="input-field pl-11" value="${formatDateForInput(val)}">
                    </div>`;
                } else if (h === 'Домашка') {
                    input = `<div class="relative">
                        <i class="fas fa-home absolute left-4 top-1/2 -translate-y-1/2 text-gray-300 text-sm"></i>
                        <select id="field-${h}" class="input-field pl-11 appearance-none">
                            <option value="">Не выбрано</option>
                            ${config.homeroom_values.map(v => `<option value="${v}" ${val === v ? 'selected' : ''}>${v}</option>`).join('')}
                        </select>
                        <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-300 text-xs pointer-events-none"></i>
                    </div>`;
                } else if (h === 'Статус') {
                    input = `<div class="relative">
                        <i class="fas fa-user-tag absolute left-4 top-1/2 -translate-y-1/2 text-gray-300 text-sm"></i>
                        <select id="field-${h}" class="input-field pl-11 appearance-none">
                            <option value="">Не выбрано</option>
                            ${config.status_values.map(v => `<option value="${v}" ${val === v ? 'selected' : ''}>${v}</option>`).join('')}
                        </select>
                        <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-300 text-xs pointer-events-none"></i>
                    </div>`;
                } else {
                    let icon = 'fa-info-circle';
                    if (h === 'Имя' || h === 'Фамилия') icon = 'fa-user';
                    if (h === 'Телефон') icon = 'fa-phone';
                    if (h === 'Telegram') icon = 'fa-paper-plane';
                    
                    input = `<div class="relative">
                        <i class="fas ${icon} absolute left-4 top-1/2 -translate-y-1/2 text-gray-300 text-sm"></i>
                        <input type="text" id="field-${h}" class="input-field pl-11" placeholder="Введите ${h.toLowerCase()}..." value="${val}">
                    </div>`;
                }
                
                return `<div class="bg-main">
                    <label class="block text-[10px] font-black text-hint uppercase tracking-widest mb-1 ml-1">${h}</label>
                    ${input}
                </div>`;
            }).join('');
        }

        function formatDateForInput(val) {
            if (!val) return '';
            // If already YYYY-MM-DD
            if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
            // If DD.MM.YYYY
            const parts = val.split('.');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
            return '';
        }

        async function savePerson() {
            const data = headers.map(h => {
                const el = document.getElementById(`field-${h}`);
                if (!el) return (currentPerson ? currentPerson[h] : '');
                let val = el.value;
                if (config.date_columns.includes(h) && val) {
                    // If input type="date" it's YYYY-MM-DD.
                    // Let's ensure it's YYYY-MM-DD for the backend.
                }
                return val;
            });
            showLoading(true);
            try {
                const url = editingRow ? `/api/miniapp/person/${editingRow}` : '/api/miniapp/person';
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data })
                });
                if (res.ok) {
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert('Запись успешно сохранена!');
                    await loadPeople();
                    if (editingRow) {
                        viewPerson(editingRow);
                    } else {
                        viewMode('main');
                    }
                } else {
                    tg.showAlert('Ошибка при сохранении');
                }
            } catch (e) {
                console.error(e);
                tg.showAlert('Сетевая ошибка при сохранении');
            }
            showLoading(false);
        }

        async function askAI() {
            const question = document.getElementById('ai-question').value;
            if (!question) return;
            
            const answerDiv = document.getElementById('ai-answer');
            answerDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Думаю...';
            
            const res = await fetch('/api/miniapp/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question })
            });
            const data = await res.json();
            answerDiv.innerText = data.answer;
        }

        function showLoading(show) {
            document.getElementById('content-loading').classList.toggle('hidden', !show);
        }

        function triggerPhotoUpload() {
            document.getElementById('photo-upload').click();
        }

        async function uploadPhoto(input) {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            showLoading(true);
            
            // Show toast or message for user
            tg.MainButton.setText('ОБРАБОТКА ФОТО...');
            tg.MainButton.show();
            tg.MainButton.disable();
            
            try {
                // Client-side compression
                const compressedFile = await compressImage(file);
                
                tg.MainButton.setText('ЗАГРУЗКА...');
                
                const formData = new FormData();
                formData.append('file', compressedFile, 'photo.jpg');
                
                const res = await fetch(`/api/miniapp/person/${currentPerson.row_index}/photo`, {
                    method: 'POST',
                    body: formData
                });
                
                if (res.ok) {
                    const data = await res.json();
                    tg.HapticFeedback.notificationOccurred('success');
                    // Update current person locally
                    currentPerson[config.col_photo] = data.photo_url;
                    // Find and update in allPeople list too
                    const personInList = allPeople.find(p => p.row_index === currentPerson.row_index);
                    if (personInList) personInList[config.col_photo] = data.photo_url;
                    
                    // Refresh current view
                    viewPerson(currentPerson.row_index);
                } else {
                    const errorData = await res.json().catch(() => ({}));
                    tg.showAlert(`Ошибка при загрузке фото: ${errorData.detail || res.statusText || res.status}`);
                }
            } catch (e) {
                console.error(e);
                tg.showAlert('Сетевая ошибка при загрузке фото');
            }
            tg.MainButton.hide();
            showLoading(false);
        }

        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        const MAX_SIZE = 1200;
                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height *= MAX_SIZE / width;
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width *= MAX_SIZE / height;
                                height = MAX_SIZE;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', 0.8);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        init();
    </script>
</body>
</html>